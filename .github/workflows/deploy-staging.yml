name: Build and Push Staging Image

on:
  push:
    branches:
      - main  # Kích hoạt khi push vào nhánh main theo yêu cầu của bạn

jobs:
  build-and-push:
    # 1. Sử dụng đúng Runner trong ảnh của bạn
    runs-on: [self-hosted, Linux, X64, build-image-staging-runner]

    steps:
      # 2. Checkout Repo chính (go-user-service) vào thư mục cùng tên
      - name: Checkout Main Repo
        uses: actions/checkout@v4
        with:
          path: go-user-service

      # 3. Checkout Repo thư viện (Ví dụ: go-lib) vào thư mục bên cạnh
      # Lưu ý: Bạn cần tạo một PAT (Personal Access Token) có quyền đọc repo thư viện
      - name: Checkout Library Repo
        uses: actions/checkout@v4
        with:
          repository: vhvplatform/go-shared # Thay bằng link repo thư viện của bạn
          token: ${{ secrets.MY_GITHUB_PAT }} 
          path: go-shared

      # 4. Login vào Private Registry
      - name: Login to Private Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY_URL }} # Ví dụ: ghcr.io hoặc 123.456.7.8:5000
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # 5. Build Image từ vị trí bên ngoài 2 repo
      - name: Debug
        run: |
          ls && pwd
      - name: Build Docker Image
        run: |
          # Đứng ở thư mục gốc (nơi chứa cả 2 repo)
          docker build -t ${{ secrets.REGISTRY_URL }}/saas/go-user-service:staging \
            -f go-user-service/Dockerfile . 
          # Lưu ý: Dockerfile của bạn phải copy được các file từ ../go-lib-shared

      # 6. Push Image lên Private Registry
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/saas-go/go-user-service:staging
