name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
      reason:
        description: 'Reason for deployment'
        required: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  approval:
    name: Approval Required
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: Approval checkpoint
        run: echo "Deployment approved for ${{ github.event.inputs.version }}"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: approval
    environment:
      name: production
      url: https://api.saas-platform.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_PROD }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Blue-Green Deployment
        run: |
          # Deploy to green environment
          kubectl set image deployment/${{ github.event.repository.name }}-green \
            ${{ github.event.repository.name }}=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.version }} \
            -n saas-framework-prod

          # Wait for rollout
          kubectl rollout status deployment/${{ github.event.repository.name }}-green -n saas-framework-prod

          # Run health checks
          sleep 30

          # Switch traffic to green
          kubectl patch service ${{ github.event.repository.name }} -n saas-framework-prod \
            -p '{"spec":{"selector":{"version":"green"}}}'

          # Keep blue for rollback
          echo "Deployment complete. Blue version kept for rollback."

      - name: Run smoke tests
        run: |
          curl -f https://api.saas-platform.io/health || exit 1
          # Add more comprehensive tests

      - name: Create deployment record
        run: |
          echo "Deployment: ${{ github.event.inputs.version }}" >> deployments.log
          echo "Reason: ${{ github.event.inputs.reason }}" >> deployments.log
          echo "Date: $(date)" >> deployments.log

      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ Production Deployment
            Version: ${{ github.event.inputs.version }}
            Reason: ${{ github.event.inputs.reason }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

      - name: Create rollback plan
        if: failure()
        run: |
          echo "Rollback command:" > rollback.sh
          echo "kubectl patch service ${{ github.event.repository.name }} -n saas-framework-prod -p '{\"spec\":{\"selector\":{\"version\":\"blue\"}}}'" >> rollback.sh
          chmod +x rollback.sh
