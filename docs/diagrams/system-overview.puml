@startuml System Overview - Go User Service
title Sơ Đồ Tổng Quan Hệ Thống - User Service

!define RECTANGLE class

' External actors
actor "Client\nApplication" as Client
actor "Admin\nUser" as Admin

' External services
cloud "API Gateway" as Gateway {
    component "Load Balancer" as LB
    component "JWT\nValidation" as JWT
    component "Rate\nLimiter" as RateLimit
}

' User Service
package "User Service" {
    ' HTTP Layer
    component "HTTP API\n(Gin)" as HTTP {
        portin "/api/v1/users"
    }
    
    ' gRPC Layer
    component "gRPC API" as GRPC {
        portin "UserService"
    }
    
    ' Middleware Layer
    component "Tenancy\nMiddleware" as Tenancy
    
    ' Handler Layer
    package "Handlers" {
        component "User\nHandler" as UserHandler
    }
    
    ' Service Layer
    package "Services" {
        component "User\nService" as UserService
        component "Validation\nService" as Validation
    }
    
    ' Repository Layer
    package "Repositories" {
        component "User\nRepository" as UserRepo
        component "Preferences\nRepository" as PrefsRepo
        component "Audit\nRepository" as AuditRepo
    }
    
    ' Domain Layer
    package "Domain" {
        component "User\nEntity" as UserEntity
        component "DTOs" as DTOs
    }
}

' Databases
database "MongoDB\nCluster" as MongoDB {
    collections "users"
    collections "user_preferences"
    collections "audit_logs"
}

' Cache
database "Redis\nCache" as Redis {
    storage "User Profiles"
    storage "Search Results"
}

' Message Queue (Future)
queue "RabbitMQ\n(Future)" as MQ {
    queue "user.events"
}

' Monitoring & Logging
cloud "Observability" {
    component "Prometheus\n(Metrics)" as Prometheus
    component "Zap Logger\n(Logs)" as Logger
    component "OpenTelemetry\n(Traces)" as Tracing
}

' External Services
cloud "External Services" {
    component "Notification\nService" as NotifService
    component "Tenant\nService" as TenantService
}

' Relationships - Request Flow
Client --> Gateway : HTTPS Request
Admin --> Gateway : HTTPS Request
Gateway --> LB : Route Request
LB --> JWT : Validate Token
JWT --> RateLimit : Check Rate
RateLimit --> HTTP : Forward Request
RateLimit --> GRPC : Forward Request

' Internal Flow - HTTP
HTTP --> Tenancy : Extract X-Tenant-ID
Tenancy --> UserHandler : Validated Request
UserHandler --> UserService : Business Logic
UserService --> Validation : Validate Input
UserService --> UserRepo : Data Access
UserService --> PrefsRepo : Preferences
UserService --> AuditRepo : Audit Trail

' Repository to Storage
UserRepo --> MongoDB : Query/Insert/Update
PrefsRepo --> MongoDB : Query/Insert/Update
AuditRepo --> MongoDB : Insert
UserRepo --> Redis : Cache Get/Set
UserRepo <-- Redis : Cached Data

' Domain dependencies
UserHandler ..> DTOs : Use
UserService ..> UserEntity : Use
UserRepo ..> UserEntity : Use

' gRPC Flow
GRPC --> UserHandler : gRPC Request
UserHandler --> UserService

' Async Events (Future)
UserService ..> MQ : Publish Events\n(user.created, user.updated)
MQ ..> NotifService : Subscribe Events

' External Service Communication
UserService --> TenantService : Validate Tenant\n(gRPC)
UserService --> NotifService : Send Notification\n(gRPC)

' Monitoring
UserService --> Prometheus : Export Metrics
UserService --> Logger : Write Logs
UserService --> Tracing : Export Traces

' Styling
skinparam component {
    BackgroundColor<<HTTP>> LightBlue
    BackgroundColor<<gRPC>> LightGreen
    BackgroundColor<<Service>> LightYellow
    BackgroundColor<<Repository>> LightCoral
    BackgroundColor<<Domain>> LightGray
}

skinparam database {
    BackgroundColor LightSkyBlue
}

skinparam cloud {
    BackgroundColor LightGoldenRodYellow
}

' Notes
note right of Tenancy
    **Multi-Tenancy Enforcement**
    - Validates X-Tenant-ID header
    - Ensures tenant isolation
    - Prevents cross-tenant access
end note

note bottom of MongoDB
    **Data Isolation**
    - All collections have tenant_id
    - Compound indexes with tenant_id
    - Unique constraints per tenant
end note

note right of Redis
    **Caching Strategy**
    - Cache-aside pattern
    - TTL: 15 minutes
    - Invalidate on update
end note

note bottom of UserService
    **Business Rules**
    - Email unique per tenant
    - Input validation & sanitization
    - Audit logging
    - GDPR compliance
end note

@enduml
