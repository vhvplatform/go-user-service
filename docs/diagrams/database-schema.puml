@startuml Database Schema
title Database Schema - User Service

!define table(x) class x << (T,#FFAAAA) >>
!define primary_key(x) <u>x</u>
!define foreign_key(x) <i>x</i>
!define index(x) {field} x

' Users Collection
table(users) {
  primary_key(_id): ObjectId
  email: String {unique with tenant_id}
  tenant_id: String {indexed}
  first_name: String
  last_name: String
  phone: String?
  avatar_url: String?
  is_active: Boolean {indexed}
  is_deleted: Boolean
  email_verified: Boolean
  email_verified_at: Timestamp?
  last_login_at: Timestamp?
  created_at: Timestamp {indexed}
  updated_at: Timestamp
  deleted_at: Timestamp?
  metadata: Map<String, Any>
  --
  **Indexes:**
  1. {email: 1, tenant_id: 1} - Unique
  2. {tenant_id: 1}
  3. {is_active: 1, tenant_id: 1}
  4. {created_at: -1}
  5. {first_name: "text", last_name: "text", email: "text"}
}

' User Preferences Collection
table(user_preferences) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  foreign_key(tenant_id): String
  language: String
  timezone: String
  theme: String
  date_format: String
  time_format: String
  currency: String
  notifications_enabled: Boolean
  email_notifications: Boolean
  push_notifications: Boolean
  settings: Map<String, Any>
  created_at: Timestamp
  updated_at: Timestamp
  --
  **Indexes:**
  1. {user_id: 1, tenant_id: 1} - Unique
  2. {tenant_id: 1}
}

' User Roles Collection (for RBAC)
table(user_roles) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String
  foreign_key(role_id): String
  foreign_key(tenant_id): String
  assigned_by: String
  assigned_at: Timestamp
  expires_at: Timestamp?
  is_active: Boolean
  --
  **Indexes:**
  1. {user_id: 1, role_id: 1, tenant_id: 1} - Unique
  2. {user_id: 1, tenant_id: 1}
  3. {role_id: 1, tenant_id: 1}
  4. {tenant_id: 1}
}

' Roles Collection (for RBAC)
table(roles) {
  primary_key(_id): ObjectId
  name: String {unique with tenant_id}
  foreign_key(tenant_id): String
  display_name: String
  description: String
  is_system: Boolean
  permissions: Array<String>
  created_at: Timestamp
  updated_at: Timestamp
  --
  **Indexes:**
  1. {name: 1, tenant_id: 1} - Unique
  2. {tenant_id: 1}
  3. {is_system: 1}
  --
  **System Roles:**
  - super_admin
  - tenant_admin
  - manager
  - user
}

' Permissions Collection (for RBAC)
table(permissions) {
  primary_key(_id): ObjectId
  resource: String
  action: String
  foreign_key(tenant_id): String
  description: String
  is_system: Boolean
  created_at: Timestamp
  --
  **Indexes:**
  1. {resource: 1, action: 1, tenant_id: 1} - Unique
  2. {tenant_id: 1}
  --
  **Permission Format:**
  resource:action
  e.g., users:read, users:write, users:delete
}

' User Sessions Collection
table(user_sessions) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  foreign_key(tenant_id): String
  session_token: String {indexed}
  refresh_token: String
  ip_address: String
  user_agent: String
  device_id: String?
  device_name: String?
  is_active: Boolean
  last_activity_at: Timestamp
  created_at: Timestamp
  expires_at: Timestamp {indexed}
  --
  **Indexes:**
  1. {session_token: 1} - Unique
  2. {user_id: 1, tenant_id: 1}
  3. {expires_at: 1} - TTL index
  4. {is_active: 1, user_id: 1}
}

' User Consents Collection (GDPR)
table(user_consents) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  foreign_key(tenant_id): String
  purpose: String
  granted: Boolean
  granted_at: Timestamp
  revoked_at: Timestamp?
  ip_address: String
  user_agent: String
  version: String
  --
  **Indexes:**
  1. {user_id: 1, purpose: 1, tenant_id: 1}
  2. {user_id: 1, tenant_id: 1}
  3. {granted: 1, purpose: 1}
  --
  **Purpose Types:**
  - marketing
  - analytics
  - third_party_sharing
  - personalization
}

' Data Export Requests (GDPR)
table(data_export_requests) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  foreign_key(tenant_id): String
  status: String {indexed}
  format: String
  file_path: String?
  download_url: String?
  requested_at: Timestamp
  completed_at: Timestamp?
  expires_at: Timestamp?
  error_message: String?
  --
  **Indexes:**
  1. {user_id: 1, tenant_id: 1}
  2. {status: 1}
  3. {expires_at: 1} - TTL index
  --
  **Status Values:**
  - pending
  - processing
  - completed
  - failed
  - expired
}

' Account Deletion Requests (GDPR)
table(account_deletion_requests) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  foreign_key(tenant_id): String
  status: String {indexed}
  requested_at: Timestamp
  scheduled_for: Timestamp {indexed}
  processed_at: Timestamp?
  cancelled_at: Timestamp?
  cancellation_reason: String?
  --
  **Indexes:**
  1. {user_id: 1} - Unique
  2. {status: 1, scheduled_for: 1}
  3. {scheduled_for: 1}
  --
  **Status Values:**
  - pending (grace period)
  - cancelled
  - completed
}

' Audit Logs
table(audit_logs) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String? {indexed}
  foreign_key(tenant_id): String {indexed}
  actor_id: String {indexed}
  actor_type: String
  action: String {indexed}
  resource: String
  resource_id: String?
  changes: Map<String, Any>
  ip_address: String
  user_agent: String
  status: String
  error_message: String?
  timestamp: Timestamp {indexed}
  metadata: Map<String, Any>
  --
  **Indexes:**
  1. {user_id: 1, timestamp: -1}
  2. {tenant_id: 1, timestamp: -1}
  3. {actor_id: 1, timestamp: -1}
  4. {action: 1, timestamp: -1}
  5. {timestamp: -1}
  --
  **Retention:** 7 years (compliance)
}

' Password History (Security)
table(password_history) {
  primary_key(_id): ObjectId
  foreign_key(user_id): String {indexed}
  password_hash: String
  created_at: Timestamp
  --
  **Indexes:**
  1. {user_id: 1, created_at: -1}
  --
  **Purpose:** Prevent password reuse
  **Retention:** Last 5 passwords
}

' Relationships
users "1" -- "0..1" user_preferences: has
users "1" -- "0..*" user_roles: has
user_roles "*" -- "1" roles: references
users "1" -- "0..*" user_sessions: has
users "1" -- "0..*" user_consents: has
users "1" -- "0..*" data_export_requests: requests
users "1" -- "0..1" account_deletion_requests: requests
users "1" -- "0..*" audit_logs: generates
users "1" -- "0..*" password_history: has

note right of users
  **Multi-Tenancy**
  All collections include tenant_id
  for data isolation
  
  **Soft Delete**
  Users are soft deleted
  (is_deleted flag)
  for audit trail
  
  **GDPR Compliance**
  - Right to access
  - Right to erasure
  - Consent management
  - Data portability
end note

note bottom of audit_logs
  **Audit Events Tracked**
  - user.created
  - user.updated
  - user.deleted
  - user.login
  - user.logout
  - user.password_changed
  - user.password_reset
  - role.assigned
  - role.revoked
  - consent.granted
  - consent.revoked
  - data.exported
  - data.deleted
  
  **Retention Policy**
  Active: 7 years
  Anonymized: On user deletion (PII removed)
end note

@enduml
