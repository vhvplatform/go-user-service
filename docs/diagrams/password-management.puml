@startuml Password Management
title Password Management - Change & Reset Flow

actor "User" as User
participant "API Gateway" as Gateway
participant "Auth Service" as Auth
participant "User Service" as UserService
database "MongoDB" as DB
participant "Notification Service" as Notify
participant "Cache (Redis)" as Cache

== Password Change (Authenticated User) ==
User -> Gateway: POST /auth/change-password\n{old_password, new_password}
activate Gateway

Gateway -> Gateway: ValidateJWT()\nExtractUserID()

Gateway -> Auth: ChangePassword(user_id, old_pass, new_pass)
activate Auth

Auth -> Auth: ValidatePasswordStrength(new_pass)\n- Min 8 chars\n- Uppercase + lowercase\n- Number + special char\n- Not in common passwords list

Auth -> DB: FindUser({_id: user_id})
activate DB
DB --> Auth: user {password_hash, password_history}
deactivate DB

Auth -> Auth: VerifyPassword(old_pass, password_hash)

alt Old Password Valid
  Auth -> Auth: HashNewPassword(new_pass)
  Auth -> Auth: CheckPasswordHistory()\n- Not in last 5 passwords
  
  Auth -> DB: UpdateOne()\n{password_hash, password_updated_at,\npassword_history: append(old_hash)}
  activate DB
  DB --> Auth: updated
  deactivate DB
  
  Auth -> Cache: InvalidateAllUserSessions(user_id)
  activate Cache
  Cache --> Auth: sessions_invalidated
  deactivate Cache
  
  Auth -> Notify: SendPasswordChangedEmail(user_email)
  activate Notify
  Notify -> User: Password Changed Email
  deactivate Notify
  
  Auth --> Gateway: Password Changed Successfully
  Gateway --> User: 200 OK\n{changed: true, login_required: true}
else Invalid Old Password
  Auth --> Gateway: 401 Unauthorized
  Gateway --> User: 401 Unauthorized\n{error: "Invalid old password"}
end

deactivate Auth
deactivate Gateway

== Password Reset Request (Forgot Password) ==
User -> Gateway: POST /auth/forgot-password\n{email}
activate Gateway

Gateway -> Auth: RequestPasswordReset(email)
activate Auth

Auth -> UserService: GetUserByEmail(email)
activate UserService

UserService -> DB: FindOne({email, is_active: true})
activate DB
DB --> UserService: user
deactivate DB

UserService --> Auth: User Found (user_id, email)
deactivate UserService

Auth -> Auth: GenerateResetToken()\n- Random secure token\n- 6-digit code (optional)\n- TTL: 1 hour

Auth -> Cache: StoreResetToken(token, user_id, expires_in: 3600)
activate Cache
Cache --> Auth: stored
deactivate Cache

Auth -> Notify: SendPasswordResetEmail(email, reset_token, reset_link)
activate Notify
Notify -> User: Password Reset Email\n{reset_link, reset_code}
deactivate Notify

Auth --> Gateway: Reset Email Sent
deactivate Auth

Gateway --> User: 200 OK\n{message: "Reset link sent to email"}
deactivate Gateway

note right of Auth
  **Security Notes**
  - Always return success even if email not found
    (prevents email enumeration)
  - Rate limit reset requests per IP
  - Log all reset attempts for audit
end note

== Password Reset Confirmation ==
User -> Gateway: POST /auth/reset-password\n{token, new_password}
activate Gateway

Gateway -> Auth: ResetPassword(token, new_pass)
activate Auth

Auth -> Cache: ValidateResetToken(token)
activate Cache
Cache --> Auth: {valid: true, user_id}
deactivate Cache

alt Token Valid
  Auth -> Auth: ValidatePasswordStrength(new_pass)
  
  Auth -> DB: FindUser({_id: user_id})
  activate DB
  DB --> Auth: user
  deactivate DB
  
  Auth -> Auth: HashNewPassword(new_pass)\nCheckPasswordHistory()
  
  Auth -> DB: UpdateOne()\n{password_hash, password_updated_at,\npassword_history: append(old_hash)}
  activate DB
  DB --> Auth: updated
  deactivate DB
  
  Auth -> Cache: DeleteResetToken(token)
  activate Cache
  Cache --> Auth: deleted
  deactivate Cache
  
  Auth -> Cache: InvalidateAllUserSessions(user_id)
  activate Cache
  Cache --> Auth: sessions_invalidated
  deactivate Cache
  
  Auth -> Notify: SendPasswordResetSuccessEmail(email)
  activate Notify
  Notify -> User: Password Reset Success Email
  deactivate Notify
  
  Auth --> Gateway: Password Reset Successfully
  Gateway --> User: 200 OK\n{reset: true, login_required: true}
else Token Invalid/Expired
  Auth --> Gateway: 400 Bad Request
  Gateway --> User: 400 Bad Request\n{error: "Invalid or expired token"}
end

deactivate Auth
deactivate Gateway

== Password Expiry Check (Login) ==
User -> Gateway: POST /auth/login\n{email, password}
activate Gateway

Gateway -> Auth: Login(email, password)
activate Auth

Auth -> DB: FindUser({email, is_active: true})
activate DB
DB --> Auth: user {password_hash, password_updated_at}
deactivate DB

Auth -> Auth: VerifyPassword(password, password_hash)

Auth -> Auth: CheckPasswordExpiry()\npassword_max_age: 90 days

alt Password Expired
  Auth --> Gateway: 403 Forbidden\n{password_expired: true}
  Gateway --> User: 403 Forbidden\n{error: "Password expired", reset_required: true}
else Password Valid
  Auth -> Auth: GenerateJWT()
  Auth --> Gateway: Login Successful\n{access_token, refresh_token}
  Gateway --> User: 200 OK\n{tokens, user}
end

deactivate Auth
deactivate Gateway

note bottom of DB
  **Password Policy Configuration**
  - Minimum length: 8 characters
  - Complexity requirements:
    * At least 1 uppercase letter
    * At least 1 lowercase letter
    * At least 1 number
    * At least 1 special character
  - Password history: Last 5 passwords
  - Password max age: 90 days
  - Account lockout: 5 failed attempts
  - Lockout duration: 30 minutes
  
  **Password Storage**
  - Algorithm: bcrypt or argon2id
  - Cost factor: 12 (bcrypt) or 3 passes (argon2id)
  - Salt: Unique per password (automatic)
end note

@enduml
