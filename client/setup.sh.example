#!/bin/bash

# ==================================
# VHV PLATFORM - SETUP SCRIPT
# ==================================
# Automated setup script for new developers

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_step() {
    echo -e "\n${BLUE}===================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}===================================${NC}\n"
}

# ==================================
# Step 1: Welcome
# ==================================
print_step "Welcome to VHV Platform Setup!"
echo "This script will help you set up the development environment."
echo ""
read -p "Press Enter to continue or Ctrl+C to exit..."

# ==================================
# Step 2: Check Prerequisites
# ==================================
print_step "Checking Prerequisites"

# Check Node.js
if command -v node &> /dev/null; then
    NODE_VERSION=$(node --version)
    print_success "Node.js $NODE_VERSION installed"
else
    print_error "Node.js is not installed"
    print_info "Please install Node.js >= 20 from https://nodejs.org"
    exit 1
fi

# Check pnpm
if command -v pnpm &> /dev/null; then
    PNPM_VERSION=$(pnpm --version)
    print_success "pnpm $PNPM_VERSION installed"
else
    print_warning "pnpm is not installed"
    read -p "Install pnpm now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        npm install -g pnpm
        print_success "pnpm installed"
    else
        print_error "pnpm is required. Exiting..."
        exit 1
    fi
fi

# Check Git
if command -v git &> /dev/null; then
    GIT_VERSION=$(git --version)
    print_success "$GIT_VERSION installed"
else
    print_error "Git is not installed"
    exit 1
fi

# ==================================
# Step 3: Copy Example Files
# ==================================
print_step "Setting up Configuration Files"

# Copy .env file
if [ ! -f ".env" ]; then
    if [ -f ".env.example" ]; then
        cp .env.example .env
        print_success "Created .env from .env.example"
        print_warning "Please update .env with your configuration"
    else
        print_error ".env.example not found"
        exit 1
    fi
else
    print_info ".env already exists, skipping..."
fi

# Copy vitest.config.ts
if [ ! -f "vitest.config.ts" ]; then
    if [ -f "vitest.config.ts.example" ]; then
        cp vitest.config.ts.example vitest.config.ts
        print_success "Created vitest.config.ts"
    fi
fi

# Copy .prettierrc
if [ ! -f ".prettierrc" ]; then
    if [ -f ".prettierrc.example" ]; then
        cp .prettierrc.example .prettierrc
        print_success "Created .prettierrc"
    fi
fi

# Copy .prettierignore
if [ ! -f ".prettierignore" ]; then
    if [ -f ".prettierignore.example" ]; then
        cp .prettierignore.example .prettierignore
        print_success "Created .prettierignore"
    fi
fi

# Copy test setup
if [ ! -f "src/tests/setup.ts" ]; then
    if [ -f "src/tests/setup.ts.example" ]; then
        mkdir -p src/tests
        cp src/tests/setup.ts.example src/tests/setup.ts
        print_success "Created src/tests/setup.ts"
    fi
fi

# Copy Docker files
if [ ! -f "Dockerfile" ]; then
    if [ -f "Dockerfile.example" ]; then
        cp Dockerfile.example Dockerfile
        print_success "Created Dockerfile"
    fi
fi

if [ ! -f "docker-compose.yml" ]; then
    if [ -f "docker-compose.example.yml" ]; then
        cp docker-compose.example.yml docker-compose.yml
        print_success "Created docker-compose.yml"
    fi
fi

if [ ! -f "nginx.conf" ]; then
    if [ -f "nginx.conf.example" ]; then
        cp nginx.conf.example nginx.conf
        print_success "Created nginx.conf"
    fi
fi

if [ ! -f "docker-entrypoint.sh" ]; then
    if [ -f "docker-entrypoint.sh.example" ]; then
        cp docker-entrypoint.sh.example docker-entrypoint.sh
        chmod +x docker-entrypoint.sh
        print_success "Created docker-entrypoint.sh"
    fi
fi

# ==================================
# Step 4: Install Dependencies
# ==================================
print_step "Installing Dependencies"

print_info "This may take a few minutes..."
pnpm install

if [ $? -eq 0 ]; then
    print_success "Dependencies installed successfully"
else
    print_error "Failed to install dependencies"
    exit 1
fi

# ==================================
# Step 5: Environment Configuration
# ==================================
print_step "Configuring Environment"

print_warning "IMPORTANT: Update your .env file with correct values!"
echo ""
echo "Required variables:"
echo "  - VITE_TENANT_ID"
echo "  - VITE_API_BASE_URL"
echo "  - VITE_TOKEN_ENCRYPTION_KEY"
echo ""

read -p "Open .env file now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if command -v code &> /dev/null; then
        code .env
    elif command -v nano &> /dev/null; then
        nano .env
    elif command -v vi &> /dev/null; then
        vi .env
    else
        print_info "Please edit .env manually"
    fi
fi

# ==================================
# Step 6: Git Configuration
# ==================================
print_step "Git Configuration"

# Set up git hooks (optional)
read -p "Set up git hooks for code quality? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    mkdir -p .git/hooks
    
    # Pre-commit hook
    cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
echo "Running pre-commit checks..."
pnpm run type-check && pnpm run lint && pnpm run format:check
EOF
    chmod +x .git/hooks/pre-commit
    print_success "Git hooks configured"
fi

# ==================================
# Step 7: Run Tests
# ==================================
print_step "Running Tests"

read -p "Run tests to verify setup? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    pnpm test
    if [ $? -eq 0 ]; then
        print_success "All tests passed!"
    else
        print_warning "Some tests failed. Please review."
    fi
fi

# ==================================
# Step 8: Build Check
# ==================================
print_step "Verifying Build"

read -p "Try building the application? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    pnpm build
    if [ $? -eq 0 ]; then
        print_success "Build successful!"
    else
        print_error "Build failed. Please check the errors above."
    fi
fi

# ==================================
# Step 9: Final Instructions
# ==================================
print_step "Setup Complete! ðŸŽ‰"

echo ""
print_success "Development environment is ready!"
echo ""
print_info "Next steps:"
echo ""
echo "1. Review and update .env file with your configuration"
echo "2. Read ONBOARDING.md for a step-by-step guide"
echo "3. Read SECURITY_GUIDE.md for security best practices"
echo ""
echo "Quick commands:"
echo "  pnpm dev              # Start development server"
echo "  pnpm test             # Run tests"
echo "  pnpm build            # Build for production"
echo "  pnpm ci               # Run all checks"
echo ""
print_info "Happy coding! ðŸš€"
echo ""

# ==================================
# Optional: Start dev server
# ==================================
read -p "Start development server now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_info "Starting development server..."
    print_info "The app will be available at http://localhost:5173"
    pnpm dev
fi
