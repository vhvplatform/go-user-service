# ==========================================
# VHV Platform - Netlify Configuration
# ==========================================
# Copy this file to netlify.toml and customize

[build]
  # Build command
  command = "pnpm build"
  
  # Output directory
  publish = "dist"
  
  # Functions directory (if using serverless functions)
  functions = "netlify/functions"

[build.environment]
  # Node version
  NODE_VERSION = "20"
  
  # pnpm version
  PNPM_VERSION = "8"
  
  # Build settings
  NODE_ENV = "production"

# ====================
# Redirect Rules
# ====================
[[redirects]]
  # SPA fallback
  from = "/*"
  to = "/index.html"
  status = 200
  force = false

[[redirects]]
  # Force HTTPS
  from = "http://*"
  to = "https://:splat"
  status = 301
  force = true

[[redirects]]
  # API proxy (optional)
  from = "/api/*"
  to = "https://api.yourdomain.com/api/:splat"
  status = 200
  force = false

# ====================
# Headers
# ====================
[[headers]]
  # Security headers for all pages
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.yourdomain.com;"

[[headers]]
  # Cache control for index.html - no caching
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

[[headers]]
  # Aggressive caching for static assets
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  # Caching for fonts
  for = "/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Access-Control-Allow-Origin = "*"

[[headers]]
  # Caching for images
  for = "/*.{jpg,jpeg,png,gif,ico,svg,webp}"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ====================
# Environment Context
# ====================

# Production
[context.production.environment]
  VITE_APP_ENV = "production"
  VITE_DEBUG_MODE = "false"
  VITE_LOG_LEVEL = "error"

# Staging (deploy-preview)
[context.deploy-preview.environment]
  VITE_APP_ENV = "staging"
  VITE_DEBUG_MODE = "true"
  VITE_LOG_LEVEL = "info"

# Branch deploys
[context.branch-deploy.environment]
  VITE_APP_ENV = "development"
  VITE_DEBUG_MODE = "true"
  VITE_LOG_LEVEL = "debug"

# ====================
# Deploy Contexts
# ====================

# Production build settings
[context.production]
  command = "pnpm build"
  
  [context.production.environment]
    NODE_ENV = "production"

# Deploy Preview settings
[context.deploy-preview]
  command = "pnpm build"
  
  [context.deploy-preview.environment]
    NODE_ENV = "staging"

# Branch deploy settings
[context.branch-deploy]
  command = "pnpm build"

# ====================
# Functions (Serverless)
# ====================
[functions]
  # Functions directory
  directory = "netlify/functions"
  
  # Node bundler
  node_bundler = "esbuild"

# ====================
# Plugins
# ====================
[[plugins]]
  # Security headers plugin
  package = "@netlify/plugin-sitemap"
  
  [plugins.inputs]
    buildDir = "dist"

[[plugins]]
  # Lighthouse CI plugin
  package = "@netlify/plugin-lighthouse"
  
  [plugins.inputs]
    budgets.performance = 90
    budgets.accessibility = 90
    budgets.best-practices = 90
    budgets.seo = 90

# ====================
# Edge Functions (Optional)
# ====================
[edge_functions]
  # Edge function for authentication
  # [[edge_functions.auth]]
  #   function = "auth"
  #   path = "/app/*"

# ====================
# Split Testing (Optional)
# ====================
# [[split_tests]]
#   path = "/"
#   branches = ["main=90%", "feature-branch=10%"]

# ====================
# Deploy Notifications
# ====================
# Configure in Netlify UI or via API

# ====================
# Custom Domain Settings
# ====================
# Configure in Netlify UI

# ====================
# Instructions
# ====================
# 1. Copy this file: cp netlify.toml.example netlify.toml
# 2. Update domain URLs
# 3. Configure environment variables in Netlify UI
# 4. Connect to Git repository
# 5. Deploy!

# ====================
# Environment Variables to Set in Netlify UI
# ====================
# VITE_TENANT_ID
# VITE_API_BASE_URL
# VITE_USER_SERVICE_URL
# VITE_AUTH_SERVICE_URL
# VITE_TOKEN_ENCRYPTION_KEY
# VITE_SUPABASE_URL
# VITE_SUPABASE_ANON_KEY
