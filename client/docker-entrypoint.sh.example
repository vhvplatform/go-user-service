#!/bin/sh
# ==================================
# Docker Entrypoint Script
# ==================================
# Handles environment variable substitution and nginx startup

set -e

echo "ðŸš€ VHV Platform - Starting application..."

# ==================================
# Environment Variable Substitution
# ==================================
# Replace environment variables in JavaScript files
if [ -d "/usr/share/nginx/html/assets" ]; then
    echo "ðŸ“ Substituting environment variables..."
    
    # Find all JS files and replace environment variables
    find /usr/share/nginx/html/assets -type f -name "*.js" -exec sed -i \
        -e "s|VITE_TENANT_ID_PLACEHOLDER|${VITE_TENANT_ID}|g" \
        -e "s|VITE_API_BASE_URL_PLACEHOLDER|${VITE_API_BASE_URL}|g" \
        -e "s|VITE_USER_SERVICE_URL_PLACEHOLDER|${VITE_USER_SERVICE_URL}|g" \
        -e "s|VITE_AUTH_SERVICE_URL_PLACEHOLDER|${VITE_AUTH_SERVICE_URL}|g" \
        {} \;
    
    echo "âœ… Environment variables substituted"
fi

# ==================================
# Health Check Endpoint
# ==================================
cat > /usr/share/nginx/html/health <<EOF
{
  "status": "healthy",
  "service": "vhv-platform-frontend",
  "version": "3.2.0",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
}
EOF

echo "âœ… Health check endpoint created"

# ==================================
# Nginx Configuration Validation
# ==================================
echo "ðŸ” Validating nginx configuration..."
nginx -t

if [ $? -eq 0 ]; then
    echo "âœ… Nginx configuration is valid"
else
    echo "âŒ Nginx configuration is invalid"
    exit 1
fi

# ==================================
# Start Nginx
# ==================================
echo "ðŸŒ Starting nginx..."
exec "$@"
